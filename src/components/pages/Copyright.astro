---
import type { CollectionKey, InferEntrySchema } from 'astro:content'
import config from '@/site-config'

import { cn, getFormattedDate } from '@/utils'
import { QRCode } from '@/components/advanced'
import { Icon } from '@/components/user'

interface Props<T extends CollectionKey> {
  data: InferEntrySchema<T>
  class?: string
}

const {
  data: { heroImage, title, publishDate },
  class: className
} = Astro.props

const image = typeof heroImage?.src === 'string' ? heroImage?.src : (heroImage?.src?.src ?? '')

const shares = {
  weibo: {
    link: `http://service.weibo.com/share/share.php?url=${Astro.url}&title=${title}&pic=${image}`
  },
  x: {
    link: `https://x.com/intent/tweet?text='${title}'&url='${Astro.url}'&via='${config.author}'`
  },
  bluesky: {
    link: `https://bsky.app/intent/compose?text=${title}%0A${Astro.url}`
  }
} as const
---

<div
  class={cn(
    'relative flex flex-col gap-y-2 rounded-xl border px-3 sm:px-4 py-2 sm:py-3',
    className
  )}
>
  <Icon class='absolute end-4 top-4 size-20 opacity-10' name='copyright' />

  <div class="absolute bottom-2 right-2 w-20 h-10 signature-container">
    <svg 
      viewBox="0 -1 163.403 90.305" 
      xmlns="http://www.w3.org/2000/svg"
      class="w-full h-full signature-svg"
    >
      <g stroke-linecap="round" fill-rule="evenodd" stroke="currentColor" stroke-width="0.3mm" fill="currentColor">
        <path 
          class="signature-path"
          d="M 24.402 85.301 Q 17.502 85.301 11.952 81.901 Q 6.402 78.501 3.202 72.051 Q 0.002 65.601 0.002 56.801 Q 0.002 41.601 6.502 28.651 Q 13.002 15.701 25.702 7.851 Q 38.402 0.001 56.202 0.001 Q 60.802 0.001 66.052 0.701 Q 71.302 1.401 75.602 2.801 Q 78.402 3.601 78.402 6.801 Q 78.402 9.401 76.452 11.701 Q 74.502 14.001 71.902 14.001 Q 71.102 14.001 70.702 13.901 Q 65.502 12.701 61.802 12.151 Q 58.102 11.601 54.002 11.601 Q 41.302 11.601 32.402 17.751 Q 23.502 23.901 19.102 34.001 Q 14.702 44.101 14.702 55.801 Q 14.702 64.301 18.052 68.951 Q 21.402 73.601 26.802 73.601 Q 32.902 73.601 37.502 68.601 Q 42.102 63.601 45.902 52.401 Q 49.702 41.201 53.402 22.001 Q 54.002 19.201 55.802 18.201 Q 57.602 17.201 60.602 17.201 Q 67.702 17.201 67.702 21.801 Q 67.702 22.601 67.402 23.801 Q 64.802 33.501 62.652 45.251 Q 60.502 57.001 60.502 63.101 Q 60.502 68.501 62.102 70.951 Q 63.702 73.401 67.002 73.401 Q 70.202 73.401 73.102 71.251 A 23.845 23.845 0 0 0 74.956 69.705 A 43.109 43.109 0 0 0 75.125 69.55 A 12.009 12.009 0 0 1 76.332 66.429 A 10.164 10.164 0 0 1 77.002 65.401 Q 79.302 62.301 83.502 62.301 Q 87.102 62.301 87.102 65.001 Q 87.102 65.701 86.902 67.501 Q 86.602 71.101 86.602 71.601 Q 86.602 74.601 89.202 74.601 Q 91.102 74.601 92.852 72.351 Q 94.602 70.101 95.752 66.201 Q 96.902 62.301 96.902 57.601 Q 96.902 54.001 96.002 51.551 Q 95.102 49.101 93.802 49.101 Q 92.702 49.101 92.202 49.651 Q 91.702 50.201 91.202 51.501 Q 90.602 53.101 89.602 54.051 Q 88.602 55.001 86.102 55.001 Q 83.902 55.001 82.602 53.451 Q 81.302 51.901 81.302 48.701 Q 81.302 43.601 84.402 40.701 Q 87.502 37.801 92.402 37.801 Q 96.602 37.801 100.002 39.851 Q 103.402 41.901 105.202 45.801 Q 108.202 41.801 111.952 39.801 Q 115.702 37.801 119.302 37.801 Q 123.202 37.801 125.252 39.601 Q 127.302 41.401 127.302 45.401 Q 127.302 49.901 125.602 52.451 Q 123.902 55.001 121.502 55.001 Q 119.302 55.001 118.502 54.101 Q 117.702 53.201 117.302 51.501 Q 117.102 50.301 116.702 49.701 Q 116.302 49.101 115.302 49.101 Q 114.102 49.101 112.752 51.351 Q 111.402 53.601 110.452 57.301 Q 109.502 61.001 109.502 65.001 Q 109.502 69.701 111.752 72.251 Q 114.002 74.801 117.902 74.801 Q 121.802 74.801 125.252 72.151 Q 127.442 70.468 130.096 67.598 A 81.726 81.726 0 0 0 130.631 67.01 A 46.575 46.575 0 0 1 130.738 65.106 Q 130.998 61.577 131.752 56.951 Q 132.902 49.901 134.702 43.801 Q 135.602 40.601 137.102 39.401 Q 138.602 38.201 141.902 38.201 Q 147.002 38.201 147.002 41.601 Q 147.002 44.101 145.102 53.201 Q 142.702 64.201 142.702 68.101 Q 142.702 71.101 143.502 72.701 Q 144.302 74.301 146.202 74.301 Q 148.002 74.301 150.702 71.801 Q 153.402 69.301 157.902 63.901 Q 159.102 62.501 160.602 62.501 Q 161.902 62.501 162.652 63.701 Q 163.402 64.901 163.402 67.001 Q 163.402 71.001 161.502 73.201 Q 151.602 85.301 143.002 85.301 Q 136.502 85.301 133.552 80.701 A 17.114 17.114 0 0 1 132.192 78.047 A 46.504 46.504 0 0 1 129.824 80.016 A 41.632 41.632 0 0 1 127.252 81.851 Q 122.002 85.301 115.402 85.301 Q 110.302 85.301 106.352 83.401 Q 102.402 81.501 100.102 78.001 Q 94.402 85.201 86.602 85.201 Q 81.102 85.201 77.902 82.001 A 10.732 10.732 0 0 1 76.686 80.537 A 42.127 42.127 0 0 1 76.431 80.739 A 31.425 31.425 0 0 1 74.402 82.201 Q 69.702 85.301 62.902 85.301 Q 55.902 85.301 51.602 81.251 Q 47.302 77.201 46.202 69.801 Q 38.802 85.301 24.402 85.301 Z M 143.802 31.601 Q 139.602 31.601 137.502 29.651 Q 135.402 27.701 135.402 24.201 Q 135.402 20.701 138.152 18.351 Q 140.902 16.001 145.002 16.001 Q 148.702 16.001 151.002 17.801 Q 153.302 19.601 153.302 22.901 Q 153.302 26.901 150.702 29.251 Q 148.102 31.601 143.802 31.601 Z" 
          vector-effect="non-scaling-stroke"
        />
      </g>
    </svg>
  </div>

  {/* title & link */}
  <div class='flex flex-col'>
    <div class='font-medium text-foreground'>{title}</div>
    <div class='text-sm'>{Astro.url}</div>
  </div>

  {/* common info */}
  <div class='flex flex-row flex-wrap justify-start gap-x-5 gap-y-1 sm:gap-x-8'>
    <div class='flex gap-x-2 sm:flex-col'>
      <span>Author</span>
      <span class='text-sm text-foreground max-sm:place-self-center'>{config.author}</span>
    </div>
    {
      publishDate && (
        <div class='flex gap-x-2 sm:min-w-16 sm:flex-col'>
          <span>Published at</span>
          <span class='text-sm text-foreground max-sm:place-self-center'>
            {getFormattedDate(publishDate, {
              month: 'long'
            })}
          </span>
        </div>
      )
    }
    <div class='flex gap-x-2 sm:flex-col'>
      <span>Copyright</span>
      <a
        class='text-sm text-foreground max-sm:place-self-center underline decoration-muted-foreground/50 underline-offset-2 rounded px-1 -mx-1 transition-all duration-200 hover:no-underline hover:bg-foreground hover:text-background'
        href='https://creativecommons.org/licenses/by/4.0/'
        target='_blank'
      >
        CC BY-NC-SA 4.0
      </a>
    </div>
  </div>

  {/* functions */}
  <div class='relative'>
    <div class='flex flex-row gap-3'>
      <button
        id='copy-link'
        class='group rounded-full bg-muted p-1 text-muted-foreground transition-colors hover:text-primary sm:p-1.5'
      >
        <Icon class='size-5' name='link' />
      </button>
      <button
        id='get-qrcode'
        class='group rounded-full bg-muted p-1 text-muted-foreground transition-colors hover:text-primary sm:p-1.5'
      >
        <Icon class='size-5' name='qrcode' />
      </button>
      {
        (config.content?.share || []).map((share: any) => (
          <a
            href={shares[share as keyof typeof shares].link}
            target='_blank'
            id={`share-${share}`}
            class='group rounded-full bg-muted p-1 text-muted-foreground transition-colors hover:text-primary sm:p-1.5'
          >
            <Icon class='size-5' name={share as any} />
          </a>
        ))
      }
    </div>
    <QRCode
      aria-expanded='false'
      class='absolute z-10 -mt-2 box-content max-h-0 max-w-44 overflow-hidden rounded-xl border bg-muted p-4 opacity-0 transition-all duration-300 ease-in-out aria-expanded:max-h-44 aria-expanded:translate-y-4 aria-expanded:opacity-100'
    />
  </div>
</div>

<div class='mx-6 rounded-b-xl border border-t-0 px-3 pb-1.5 pt-1 sm:mx-8 sm:px-4'>
  <a
    href='/projects#sponsorship'
    class='flex items-center justify-between text-muted-foreground no-underline'
  >
    <span>Buy me a cup of coffee â˜•.</span>
    <Icon class='box-content size-5 p-1' name='receive-money' />
  </a>
</div>

<style>
  .signature-container {
    color: rgba(75, 85, 99, 0.7);
    transition: all 0.3s ease;
  }

  :global([data-theme="dark"]) .signature-container,
  :global(.dark) .signature-container {
    color: rgba(156, 163, 175, 0.8);
  }

  @media (prefers-color-scheme: dark) {
    .signature-container {
      color: rgba(156, 163, 175, 0.8);
    }
  }

  .signature-container:hover {
    color: rgba(75, 85, 99, 0.9);
    transform: scale(1.05);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  }


  :global([data-theme="dark"]) .signature-container:hover,
  :global(.dark) .signature-container:hover {
    color: rgba(203, 213, 225, 0.95);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
  }

  @media (prefers-color-scheme: dark) {
    .signature-container:hover {
      color: rgba(203, 213, 225, 0.95);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
    }
  }

  .signature-path {
    fill: none;
    stroke: currentColor;
    stroke-linecap: round;
    stroke-linejoin: round;
    opacity: 1;
  }

  .signature-path.animate {
    animation: signature-loop 8s ease-in-out infinite;
  }

  @keyframes signature-loop {
    0% {
      stroke-dashoffset: var(--path-length);
    }
    30% {
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dashoffset: 0;
    }
    70% {
      stroke-dashoffset: var(--path-length);
    }
    100% {
      stroke-dashoffset: var(--path-length);
    }
  }

  .signature-container:hover .signature-path {
    animation-play-state: paused;
  }

  .signature-svg {
    filter: contrast(1.1) brightness(0.95);
  }
</style>

<script>
  import { showToast } from '@/utils'

  // Copy link
  const copyLink = document.getElementById('copy-link')
  copyLink?.addEventListener('click', () => {
    navigator.clipboard.writeText(window.location.href)
    // Show toast
    showToast({ message: 'Link copied!' })
  })

  // QRCode
  const getQRCode = document.getElementById('get-qrcode')
  const qrcodeContainer = document.getElementById('qrcode-container')
  if (!qrcodeContainer) throw new Error('qrcode container not found')
  getQRCode?.addEventListener('click', () => {
    if (qrcodeContainer.ariaExpanded === 'true') {
      qrcodeContainer.ariaExpanded = 'false'
    } else {
      qrcodeContainer.ariaExpanded = 'true'
    }
  })

  const signaturePath = document.querySelector('.signature-path') as SVGPathElement | null
  if (signaturePath) {
    const pathLength = signaturePath.getTotalLength()
    signaturePath.style.strokeDasharray = pathLength.toString()
    signaturePath.style.strokeDashoffset = pathLength.toString()
    signaturePath.style.setProperty('--path-length', pathLength.toString())
    setTimeout(() => {
      signaturePath.classList.add('animate')
    }, 500)
  }
</script>
